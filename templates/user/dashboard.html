{% extends 'base.html' %}

{% block title %}My Dashboard{% endblock %}

{% block content %}
    <div class="dashboard-header">
        <h1 class="dashboard-title">
            <i class="fas fa-thermometer-half"></i> Cold Room Monitor
        </h1>
        <p class="dashboard-subtitle">Real-time temperature monitoring dashboard</p>
    </div>

    {% if is_admin_view and all_locations %}
        <!-- Enhanced Location Selector for Admins -->
        <div class="location-selector-card">
            <div class="card-header">
                <i class="fas fa-map-marker-alt"></i> Location Selection
            </div>
            <div class="row align-items-center">
                <div class="col-md-8">
                    <select id="locationSelect" class="form-select enhanced-select" onchange="changeLocation()">
                        <option value="">üè¢ Choose a Location</option>
                        {% for loc in all_locations %}
                            <option value="{{ loc.id }}"
                                    {% if selected_location_id == loc.id %}selected{% endif %}>
                                üìç {{ loc.name }}
                            </option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-4">
                    <small class="text-muted">
                        <i class="fas fa-info-circle"></i> Select location to view cold rooms
                    </small>
                </div>
            </div>
        </div>

        <script>
        function changeLocation() {
            const select = document.getElementById('locationSelect');
            const locationId = select.value;

            if (locationId) {
                window.location.href = `{{ url_for('user_dashboard') }}?location_id=${locationId}`;
            } else {
                window.location.href = `{{ url_for('user_dashboard') }}`;
            }
        }
        </script>
    {% endif %}

    {% if show_location_selector %}
        <div class="empty-state-card">
            <div class="empty-state-content">
                <i class="fas fa-search-location empty-state-icon"></i>
                <h3>Select a Location</h3>
                <p>Please choose a location from the dropdown above to view cold room temperature data.</p>
            </div>
        </div>
    {% elif location %}
        <!-- Location Header -->
        <div class="location-header">
            <h2 class="location-title">
                <i class="fas fa-building"></i> {{ location.name }}
            </h2>
            <div class="location-stats">
                <span class="stat-badge">
                    <i class="fas fa-cube"></i>
                    {{ cold_rooms|length }} Cold Room{{ 's' if cold_rooms|length != 1 else '' }}
                </span>
            </div>
        </div>

        {% if cold_rooms %}
            <!-- Temperature Status Overview -->
            <div class="status-overview">
                <div class="row">
                    <div class="col-lg-3 col-md-6 mb-3">
                        <div class="status-card status-normal">
                            <div class="status-icon">
                                <i class="fas fa-check-circle"></i>
                            </div>
                            <div class="status-content">
                                <h4>Normal</h4>
                                {% set normal_count = [] %}
                                {% for room in cold_rooms %}
                                    {% if room.latest_temp and room.latest_temp >= -5 and room.latest_temp <= 5 %}
                                        {% set _ = normal_count.append(1) %}
                                    {% endif %}
                                {% endfor %}
                                <span class="status-count">{{ normal_count|length }}</span>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-3 col-md-6 mb-3">
                        <div class="status-card status-warning">
                            <div class="status-icon">
                                <i class="fas fa-exclamation-triangle"></i>
                            </div>
                            <div class="status-content">
                                <h4>Warning</h4>
                                {% set warning_count = [] %}
                                {% for room in cold_rooms %}
                                    {% if room.latest_temp and (room.latest_temp < -5 or room.latest_temp > 5) %}
                                        {% set _ = warning_count.append(1) %}
                                    {% endif %}
                                {% endfor %}
                                <span class="status-count">{{ warning_count|length }}</span>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-3 col-md-6 mb-3">
                        <div class="status-card status-offline">
                            <div class="status-icon">
                                <i class="fas fa-wifi-slash"></i>
                            </div>
                            <div class="status-content">
                                <h4>Offline</h4>
                                <span class="status-count">{{ cold_rooms|rejectattr('latest_temp')|list|length }}</span>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-3 col-md-6 mb-3">
                        <div class="status-card status-total">
                            <div class="status-icon">
                                <i class="fas fa-cube"></i>
                            </div>
                            <div class="status-content">
                                <h4>Total</h4>
                                <span class="status-count">{{ cold_rooms|length }}</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Cold Rooms Grid -->
            <div class="cold-rooms-grid">
                <div class="section-header">
                    <h3><i class="fas fa-cube"></i> Cold Rooms</h3>
                    <div class="refresh-button">
                        <button class="btn btn-outline-primary btn-sm" onclick="window.location.reload()">
                            <i class="fas fa-sync-alt"></i> Refresh
                        </button>
                    </div>
                </div>

                <div class="row">
                    {% for room in cold_rooms %}
                    <div class="col-xl-4 col-lg-6 col-md-12 mb-4">
                        <div class="cold-room-card {% if room.latest_temp %}
                            {% if room.latest_temp >= -5 and room.latest_temp <= 5 %}card-normal{% else %}card-warning{% endif %}
                        {% else %}card-offline{% endif %}">

                            <!-- Card Header -->
                            <div class="card-header-custom">
                                <div class="room-name">
                                    <i class="fas fa-snowflake"></i>
                                    <h4>{{ room.name }}</h4>
                                </div>
                                <div class="room-status">
                                    {% if room.latest_temp %}
                                        {% if room.latest_temp >= -5 and room.latest_temp <= 5 %}
                                            <span class="status-dot status-online"></span>
                                        {% else %}
                                            <span class="status-dot status-alert"></span>
                                        {% endif %}
                                    {% else %}
                                        <span class="status-dot status-offline-dot"></span>
                                    {% endif %}
                                </div>
                            </div>

                            <!-- Temperature Display -->
                            <div class="temperature-display">
                                {% if room.latest_temp %}
                                    <div class="temp-main">
                                        <span class="temp-value">{{ "%.1f"|format(room.latest_temp) }}</span>
                                        <span class="temp-unit">¬∞C</span>
                                    </div>
                                    <div class="temp-status">
                                        {% if room.latest_temp >= -5 and room.latest_temp <= 5 %}
                                            <i class="fas fa-check-circle text-success"></i>
                                            <span class="text-success">Normal Range</span>
                                        {% elif room.latest_temp > 5 %}
                                            <i class="fas fa-arrow-up text-danger"></i>
                                            <span class="text-danger">Too Warm</span>
                                        {% else %}
                                            <i class="fas fa-arrow-down text-warning"></i>
                                            <span class="text-warning">Too Cold</span>
                                        {% endif %}
                                    </div>
                                {% else %}
                                    <div class="temp-main offline">
                                        <i class="fas fa-question-circle"></i>
                                        <span class="offline-text">No Data</span>
                                    </div>
                                    <div class="temp-status">
                                        <i class="fas fa-exclamation-triangle text-muted"></i>
                                        <span class="text-muted">Sensor Offline</span>
                                    </div>
                                {% endif %}
                            </div>

                            <!-- Room Details -->
                            <div class="room-details">
                                <div class="detail-row">
                                    <span class="detail-label">
                                        <i class="fas fa-microchip"></i> Sensor ID
                                    </span>
                                    <span class="detail-value">
                                        {% if room.sensor_id %}
                                            <code>{{ room.sensor_id }}</code>
                                        {% else %}
                                            <span class="text-muted">Not configured</span>
                                        {% endif %}
                                    </span>
                                </div>
                                <div class="detail-row">
                                    <span class="detail-label">
                                        <i class="fas fa-clock"></i> Last Updated
                                    </span>
                                    <span class="detail-value">
                                        {% if room.latest_time %}
                                            <span title="{{ room.latest_time }}">{{ room.latest_time }}</span>
                                        {% else %}
                                            <span class="text-muted">Never</span>
                                        {% endif %}
                                    </span>
                                </div>
                                {% if is_admin_view %}
                                <div class="detail-row">
                                    <span class="detail-label">
                                        <i class="fas fa-map-marker-alt"></i> Location
                                    </span>
                                    <span class="detail-value">{{ room.location_name }}</span>
                                </div>
                                {% endif %}
                            </div>

                            <!-- Card Actions -->
                            <div class="card-actions">
                                <a href="{{ url_for('view_cold_room_data', cold_room_id=room.id) }}"
                                   class="btn btn-primary btn-block">
                                    <i class="fas fa-chart-line"></i> View Details & Chart
                                </a>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        {% else %}
            <div class="empty-state-card">
                <div class="empty-state-content">
                    <i class="fas fa-cube empty-state-icon"></i>
                    <h3>No Cold Rooms Found</h3>
                    <p>No cold rooms are configured for this location, or no sensor data is available.</p>
                    {% if is_admin_view %}
                        <a href="{{ url_for('manage_cold_rooms', location_id=location.id) }}" class="btn btn-primary">
                            <i class="fas fa-plus"></i> Add Cold Room
                        </a>
                    {% endif %}
                </div>
            </div>
        {% endif %}
    {% else %}
        <div class="empty-state-card">
            <div class="empty-state-content">
                <i class="fas fa-user-slash empty-state-icon"></i>
                <h3>No Location Assigned</h3>
                <p>You are not assigned to any location. Please contact an administrator to get access.</p>
                <button class="btn btn-outline-primary" onclick="window.location.href='mailto:admin@company.com'">
                    <i class="fas fa-envelope"></i> Contact Admin
                </button>
            </div>
        </div>
    {% endif %}

    <!-- Auto-refresh functionality -->
    <script>
        // Auto-refresh every 30 seconds
        setTimeout(function() {
            window.location.reload();
        }, 30000);

        // Add visual feedback for refresh
        let refreshTimer = 30;
        const refreshButton = document.querySelector('.refresh-button button');

        if (refreshButton) {
            setInterval(function() {
                refreshTimer--;
                if (refreshTimer <= 0) {
                    refreshTimer = 30;
                }
            }, 1000);
        }
    </script>
{% endblock %}
